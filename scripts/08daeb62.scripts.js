function postSearchFilter(a,b){return b?_.filter(a,function(a){return-1!=a.name.indexOf(b)}):a}function makePost(a){var b={};return _.extend(b,a),b.loadContentFromJekyllData=function(a){var c=decodeURIComponent(escape(a)).split("---");b.content={text:c.pop().replace(/^\n/,""),meta:jsyaml.load(c.pop())}},b.convertContentToJekyllData=function(){if(!b.content)return"";var a=["---",jsyaml.dump(b.content.meta),"---",b.content.text].join("\n");return unescape(encodeURIComponent(a))},b.commitData=function(){return{sha:b.sha,content:btoa(b.convertContentToJekyllData()),message:"commit from cms"}},b.setMenuItem=function(a){b.content&&(b.content.meta.tags=_.filter(b.content.meta.tags,function(a){return!/^menu:/.test(a)}),a&&b.content.meta.tags.push("menu:"+a))},b.setSection=function(a){return b.content?a?void(b.content.meta.section=a.value):void(b.content.meta.section=""):void 0},b}var cms=angular.module("cmsApp",["ngRoute"]);cms.config(["$routeProvider","$locationProvider",function(a){a.when("/auth",{controller:"AuthenticationCtrl",templateUrl:"views/auth.html"}).when("/posts",{controller:"PostsCtrl",templateUrl:"views/posts.html"}).when("/posts/:sha",{controller:"PostCtrl",templateUrl:"views/post.html"}).otherwise({redirectTo:"/auth"})}]),cms.factory("oauth",function(){return OAuth.initialize("S2shWzj2Cp87Mg4estazc6DFGQc"),OAuth}),cms.filter("postSearchFilter",function(){return postSearchFilter}),cms.directive("ckEditor",function(){return{require:"?ngModel",link:function(a,b,c,d){var e=CKEDITOR.replace(b[0]);e.on("instanceReady",function(){e.setData(d.$viewValue)}),e.on("pasteState",function(){a.$apply(function(){d.$setViewValue(e.getData())})}),d.$render=function(){e.setData(d.$modelValue)}}}}),angular.module("cmsApp").controller("PostCtrl",["$scope","$rootScope","$routeParams",function(a,b,c){function d(a){return b.posts.filter(function(b){return b.sha==a}).shift(0)}function e(a){return"https://api.github.com/repos/movimento-sem-terra/site-novo/git/blobs/"+a}function f(a){return"/repos/movimento-sem-terra/site-novo/contents/_drafts/"+a}var g=c.sha;a.post=d(g),a.menuTagOptions=["agricultura camponesa","agronegócio","direitos humanos","educação, cultura e comunicação","lutas e mobilizações","solidariedade internacional","meio ambiente","projeto popular","reforma agrária","transgênicos"],a.sectionOptions=[{label:"Destaque",value:"featured-news"},{label:"Carrossel",value:"carousel"},{label:"Artigo",value:"articles"},{label:"Entrevista",value:"interviews"},{label:"Debate",value:"debate"},{label:"Capa",value:"cover"},{label:"Recente",value:"recent"},{label:"Reportagens Especiais",value:"special-stories"},{label:"MST TV",value:"tv"}],a.menuTag=void 0,a.section=void 0,a.$watch("menuTag",function(b){a.post.setMenuItem(b)}),a.$watch("section",function(b){a.post.setSection(b)}),b.github.get(e(g)).done(function(b){a.post.loadContentFromJekyllData(atob(b.content)),a.$apply()}),a.save=function(a){b.github.put(f(a.name),{data:JSON.stringify(a.commitData())}).done(function(){alert("Post salvo com sucesso!")}).fail(function(a){alert("Erro ao salvar post. Tente novamente."),console.log("error data:",a)})}}]),angular.module("cmsApp").controller("PostsCtrl",["$scope","$rootScope",function(a,b){b.github.get("/repos/movimento-sem-terra/site-novo/contents/_drafts").done(function(c){b.posts=_.map(c,makePost),a.$apply()})}]);var cms=angular.module("cmsApp").controller("AuthenticationCtrl",["$scope","$rootScope","$location","oauth",function(a,b,c,d){a.authenticate=function(){d.popup("github",function(d,e){return d?alert(d):(b.github=e,c.path("/posts"),void a.$apply())})}}]);